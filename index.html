<!DOCTYPE html>
<html>

<head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <div class="container">
        <div class="loader"></div>
        <ul id="list" class="comments">

        </ul>
        <div class="add-form">
            <input id="text_input" type="text" class="add-form-name" placeholder="Введите ваше имя" />
            <textarea id="name_input" type="textarea" class="add-form-text" placeholder="Введите ваш коментарий"
                rows="4"></textarea>
            <div class="add-form-row">
                <button id="addformbutton" class="add-form-button">Написать</button>
            </div>
        </div>
    </div>
</body>
<script>
    "use strict";
    const clearInputFields = () => {
        NameInputElement.value = "";
        CommentInputElement.value = "";
    };
    let comments = [];
    let users = [];
    const loaderBlock = document.querySelector(".loader");
    const add_form = document.querySelector(".add-form");
    const NameInputElement = document.getElementById("text_input");
    const CommentInputElement = document.getElementById("name_input");
    const ButtonInputElement = document.getElementById("addformbutton");
    const ListCommentsElement = document.getElementById("list");
    const commentDate = new Date();

    const text = CommentInputElement.value;
    const name = NameInputElement.value;

    const like = () => {
        const likeButtons = document.querySelectorAll(".like-button")
        for (const like of likeButtons) {
            like.addEventListener('click', (event) => {
                event.stopPropagation()
                const com = comments[like.dataset.index]
                let a = com.likes
                if (com.isLiked === false) {
                    com.isLiked = true
                    like.classList.add("-active-like")
                    com.likes++
                } else if (com.isLiked === true) {
                    com.isLiked = false
                    com.likes--
                }
                renderUsers()
            })
        }
    }

    const fetchAndRenderUsers = () => {
        loaderBlock.textContent = `Загрузка`;
        return fetch("https://wedev-api.sky.pro/api/v1/Egor-Torgowichev/comments", {
            method: "GET"
        })
            .then((responseData) => {
                if(!responseData.ok){
                    throw new Error("Ошибка при получении комментариев")
                }
                return responseData;
            })
            .then((response) => {
                return response.json();
            })
            .then((responseData) => {
                loaderBlock.textContent = "";
                comments = responseData.comments;
                renderUsers()
            })
            .catch((error)=>{
                alert("Произошла ошибка при получении коммментариев");
                console.log(error);
            })
    }


    const commentClick = () => {
        const comments = document.querySelectorAll(".comment");
        comments.forEach((comment) => {
            comment.addEventListener("click", () => {
                const existingComment = CommentInputElement.value;
                const clickedComment = comment.querySelector(".comment-text").textContent;
                CommentInputElement.value = existingComment + clickedComment;
                CommentInputElement.innerHTML = renderUsers;

            });
        });
    };
    const renderUsers = () => {
        let commentsHTML = comments.map((comment, index) => {
            const commentDate = new Date(comment.date);
            const timeDate = commentDate.toLocaleDateString() + ' ' + commentDate.getHours() + ':' + commentDate.getMinutes();
            return `<li class="comment">
        <div class="comment-header">
            <div>${comment.author.name}</div>
            <div>${timeDate}</div>
        </div>
        <div class="comment-body">
            <div class="comment-text">
            ${comment.text}
            </div>
        </div>
        <div class="comment-footer">
            <div class="likes">
            <span class="likes-counter">${comment.likes}</span>
            <button class="like-button ${comment.isLiked ? '-active-like' : ''}" data-index='${index}'></button>
            </div>
        </div>
        </li>`;
        })
            .join("");
        ListCommentsElement.innerHTML = commentsHTML;
        commentClick()
        like()
    }
    const addComment = () => {
        const text = CommentInputElement.value;
        const name = NameInputElement.value;
        ButtonInputElement.disabled = true;
        ButtonInputElement.textContent = "Элемент добавляется...";
        fetchPromiseNew();
        clearInputFields();
        ButtonInputElement.disabled = false;
        ButtonInputElement.textContent = "Написать";
    }
    const fetchPromiseNew = () => fetch("https://wedev-api.sky.pro/api/v1/Egor-Torgowichev/comments",
        {
            method: "POST",
            body: JSON.stringify({
                text: CommentInputElement.value,
                name: NameInputElement.value
            })
        })
        .then ((response) =>{
            console.log(response)
            if (response.status === 201){
                return response.json()
            } else {
                return response.json().then((errorData) => {
                    if (response.status === 400){
                        throw new error("BadRequest:" + errorData.message)
                    } else if (response.status === 500){
                        throw new error("ServerUnavailable: Непредвиденная ошибкуа сервера")
                    }else {
                        throw new error("ServerError: Сервер упал")
                    }
                })
            }

        })
        .then((responseData) => {
            if (!responseData.ok) {
                throw new Error("Ошибка при добавлении комментария");
            }
            loaderBlock.textContent = `Загрузка`;
            return responseData;
        })
        .then((responseData) => {
            return fetch(
                "https://wedev-api.sky.pro/api/v1/Egor-Torgowichev/comments",
                {
                    method: "GET",
                }
            )
        })
        .then((response) => {
            if (!response.ok) {
                throw new Error("Ошибка при получении комментариев");
            }
            return response.json();
        })
        .then((responseData) => {
            comments = responseData.comments;
            loaderBlock.textContent = "";
            renderUsers()
        })
        .catch((error) => {
            if (error.message.startsWith("BadRequest:")){
                alert('Некорректные данные. Заполните все поля и проверьте введеные данные')
            } else if (error.message.startsWith("ServerUnavailable:")){
                alert('Сервер временно не работает. Попробуйте попозже')
            } else if (error.message.startsWith("ServerError:") || error.message.startsWith("Error:")){
                alert('Что то пошло не так, попробуйте попозже')
            } else {
                alert('Неизвестная ошибка')
            }
            console.warn(error)
        })

    ButtonInputElement.addEventListener("click", () => {
        addComment()
    });
fetchAndRenderUsers()

</script>

</html>

